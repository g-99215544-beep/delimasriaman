<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Rekod Murid</title>
    <!-- Tailwind CSS untuk styling pantas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <!-- Konfigurasi URL API di sini -->
    <input type="hidden" id="apiUrl" value="https://script.google.com/macros/s/AKfycbyxJhuyvjSdxCjctc983FS1oj3APQitMjIKUMAd7MEMeIaEnL5gUgVinOBfrVd_D4129Q/exec">

    <!-- Header -->
    <nav class="bg-blue-700 text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                </svg>
                <h1 class="text-xl font-bold tracking-wide">Sistem Rekod Murid</h1>
            </div>
            <button onclick="fetchData()" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded text-sm flex items-center gap-2 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                Refresh
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- Left Column: Form Tambah -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-xl shadow-md p-6 sticky top-24">
                <h2 class="text-lg font-bold mb-4 flex items-center gap-2 text-blue-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                    </svg>
                    Tambah Murid Baru
                </h2>
                
                <form id="studentForm" onsubmit="handleSubmit(event)">
                    <!-- Nama -->
                    <div class="mb-4">
                        <label class="block text-sm font-semibold mb-2 text-gray-600">Nama Penuh</label>
                        <input type="text" id="nama" required 
                            class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-slate-50"
                            placeholder="Contoh: Ali bin Abu">
                    </div>

                    <!-- Kelas -->
                    <div class="mb-4">
                        <label class="block text-sm font-semibold mb-2 text-gray-600">Kelas</label>
                        <select id="kelas" required 
                            class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-slate-50">
                            <option value="" disabled selected>Pilih Kelas</option>
                            <option value="1 Arif">1 Arif</option>
                            <option value="1 Bestari">1 Bestari</option>
                            <option value="2 Cerdik">2 Cerdik</option>
                            <option value="2 Dedikasi">2 Dedikasi</option>
                            <option value="3 Efisien">3 Efisien</option>
                            <option value="4 Fikir">4 Fikir</option>
                            <option value="5 Gemilang">5 Gemilang</option>
                        </select>
                    </div>

                    <!-- Jantina -->
                    <div class="mb-6">
                        <label class="block text-sm font-semibold mb-2 text-gray-600">Jantina</label>
                        <div class="flex gap-4">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="jantina" value="Lelaki" required class="text-blue-600 focus:ring-blue-500">
                                <span class="text-sm">Lelaki</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="jantina" value="Perempuan" required class="text-pink-600 focus:ring-pink-500">
                                <span class="text-sm">Perempuan</span>
                            </label>
                        </div>
                    </div>

                    <!-- Butang Submit -->
                    <button type="submit" id="btnSubmit" 
                        class="w-full bg-blue-700 hover:bg-blue-800 text-white font-bold py-2 px-4 rounded-lg shadow transition flex justify-center items-center gap-2">
                        <span>Simpan Data</span>
                    </button>
                </form>
            </div>
        </div>

        <!-- Right Column: Senarai Data -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-xl shadow-md overflow-hidden">
                <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
                    <h2 class="text-lg font-bold text-gray-700 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                        </svg>
                        Senarai Murid
                    </h2>
                    <span id="recordCount" class="text-xs font-semibold bg-blue-100 text-blue-800 px-2 py-1 rounded-full">0 Rekod</span>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-100 text-slate-600 uppercase text-xs font-semibold">
                            <tr>
                                <th class="p-4 border-b w-10">No</th>
                                <th class="p-4 border-b">Nama Murid</th>
                                <th class="p-4 border-b">Kelas</th>
                                <th class="p-4 border-b">Jantina</th>
                                <th class="p-4 border-b text-center w-20">Tindakan</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="text-sm">
                            <!-- Data akan dimasukkan di sini oleh JavaScript -->
                            <tr>
                                <td colspan="5" class="p-8 text-center text-gray-500">
                                    <div class="flex flex-col items-center justify-center">
                                        <div class="loader mb-2"></div>
                                        <p>Sedang memuatkan data...</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 transform translate-y-20 opacity-0 transition-all duration-300 z-50">
        <div class="bg-gray-800 text-white px-6 py-3 rounded-lg shadow-xl flex items-center gap-3">
            <span id="toastIcon">✅</span>
            <span id="toastMessage">Operasi Berjaya</span>
        </div>
    </div>

    <script>
        // --- GLOBAL VARIABLES ---
        let globalData = []; // Menyimpan data murid di memori
        const apiUrl = document.getElementById('apiUrl').value;
        const loadingRow = `
            <tr>
                <td colspan="5" class="p-8 text-center text-gray-500">
                    <div class="flex flex-col items-center justify-center">
                        <div class="loader mb-2"></div>
                        <p>Sedang memuatkan data...</p>
                    </div>
                </td>
            </tr>`;

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchData();
        });

        // --- FUNCTIONS ---

        // 1. Ambil Data (GET)
        async function fetchData() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = loadingRow;

            try {
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                // Simpan dalam variable global
                // Kita anggap data[0] adalah data sebenar, atau jika ada header kita boleh filter
                // Untuk keselamatan, kita check structure
                globalData = data; 
                
                renderTable();
                showToast('Data berjaya dikemaskini', 'success');

            } catch (error) {
                console.error(error);
                tbody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-red-500">Gagal memuatkan data. Sila refresh.</td></tr>`;
                showToast('Ralat sambungan server', 'error');
            }
        }

        // 2. Paparkan Data ke Table
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const countBadge = document.getElementById('recordCount');
            tbody.innerHTML = '';

            // Jika kosong
            if (!globalData || globalData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-400">Tiada rekod dijumpai.</td></tr>`;
                countBadge.textContent = "0 Rekod";
                return;
            }

            countBadge.textContent = `${globalData.length} Rekod`;

            // Loop setiap data
            // Nota: Index diterbalikkan supaya data baru (bawah sekali) nampak di atas? 
            // Atau standard (0 ke atas). Kita guna standard 0 ke atas.
            globalData.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-blue-50 transition border-b border-gray-100 last:border-0";
                
                // Pastikan data wujud, jika tidak letak '-'
                const nama = row[0] || '-';
                const kelas = row[1] || '-';
                const jantina = row[2] || '-';

                // Warna badge jantina
                const jantinaClass = jantina === 'Lelaki' 
                    ? 'bg-blue-100 text-blue-700' 
                    : (jantina === 'Perempuan' ? 'bg-pink-100 text-pink-700' : 'bg-gray-100 text-gray-600');

                tr.innerHTML = `
                    <td class="p-4 font-mono text-gray-500 text-xs">${index + 1}</td>
                    <td class="p-4 font-semibold text-gray-700">${nama}</td>
                    <td class="p-4 text-gray-600">${kelas}</td>
                    <td class="p-4">
                        <span class="text-xs px-2 py-1 rounded-full font-bold ${jantinaClass}">${jantina}</span>
                    </td>
                    <td class="p-4 text-center">
                        <button onclick="deleteStudent(${index})" class="text-red-400 hover:text-red-600 transition" title="Padam">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // 3. Tambah Data (Submit Form)
        async function handleSubmit(e) {
            e.preventDefault();
            
            const btn = document.getElementById('btnSubmit');
            const originalBtnText = btn.innerHTML;
            
            // UI Loading state
            btn.disabled = true;
            btn.innerHTML = `<div class="loader border-white border-t-transparent w-4 h-4 mr-2"></div> Menyimpan...`;

            // Ambil value dari form
            const nama = document.getElementById('nama').value;
            const kelas = document.getElementById('kelas').value;
            const jantina = document.querySelector('input[name="jantina"]:checked')?.value;

            // Masukkan data baru ke dalam array globalData
            // Ini penting supaya kita hantar SEMUA data balik ke sheet (Sebab sheet akan overwrite)
            const newData = [nama, kelas, jantina];
            globalData.push(newData);

            try {
                // Hantar ke Apps Script (POST)
                await sendDataToSheet(globalData);
                
                // Reset form jika berjaya
                document.getElementById('studentForm').reset();
                showToast('Murid berjaya ditambah!', 'success');
                
                // Render semula table dengan data baru
                renderTable();

            } catch (error) {
                console.error(error);
                showToast('Gagal menyimpan data.', 'error');
                // Jika gagal, buang balik data yang baru push tadi dari memory
                globalData.pop(); 
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalBtnText;
            }
        }

        // 4. Padam Data
        async function deleteStudent(index) {
            if(!confirm("Adakah anda pasti mahu memadam rekod ini?")) return;

            // UI Feedback sementara menunggu
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = loadingRow;

            // Buang dari array
            globalData.splice(index, 1);

            try {
                await sendDataToSheet(globalData);
                showToast('Rekod dipadam.', 'success');
                renderTable();
            } catch (error) {
                showToast('Gagal memadam data.', 'error');
                fetchData(); // Reload data asal jika error
            }
        }

        // 5. Fungsi Helper: Hantar ke API
        async function sendDataToSheet(dataToSend) {
            await fetch(apiUrl, {
                method: 'POST',
                redirect: "follow",
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify(dataToSend)
            });
        }

        // 6. UI: Toast Notification
        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            const msgSpan = document.getElementById('toastMessage');
            const iconSpan = document.getElementById('toastIcon');

            msgSpan.textContent = msg;
            iconSpan.textContent = type === 'success' ? '✅' : '❌';
            
            // Show
            toast.classList.remove('translate-y-20', 'opacity-0');
            
            // Hide after 3s
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }
    </script>
</body>
</html>
