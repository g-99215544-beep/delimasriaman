<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Semak & Edit ID Delima Murid - SK Sri Aman</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; position: relative; padding-right: 100px; }
        .header h1 { font-size: 24px; margin-bottom: 5px; }
        .header p { font-size: 14px; opacity: 0.9; }
        .admin-icon { position: absolute; top: 20px; right: 20px; font-size: 24px; cursor: pointer; transition: transform 0.2s; }
        .admin-icon:hover { transform: scale(1.1); }
        .bell-icon { position: absolute; top: 20px; right: 55px; font-size: 24px; cursor: pointer; transition: transform 0.2s; }
        .bell-icon:hover { transform: scale(1.1); }
        .badge { position: absolute; top: 12px; right: 47px; background: #ef4444; color: white; border-radius: 50%; padding: 2px 6px; font-size: 11px; font-weight: bold; min-width: 18px; text-align: center; display: none; }
        .badge.show { display: block; }
        .controls { padding: 20px; background: #f9fafb; border-bottom: 1px solid #e5e7eb; }
        .controls-row { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        input[type="text"], select { padding: 10px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px; flex: 1; min-width: 200px; }
        button { padding: 10px 20px; border: none; border-radius: 4px; font-size: 14px; cursor: pointer; transition: background 0.2s; font-weight: 500; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-secondary:hover { background: #4b5563; }
        .admin-only { display: none; }
        .admin-mode .admin-only { display: inline-block; }
        .table-container { overflow-x: auto; padding: 20px; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { background: #f3f4f6; padding: 12px; text-align: left; font-weight: 600; border-bottom: 2px solid #e5e7eb; position: sticky; top: 0; white-space: nowrap; }
        td { padding: 10px 12px; border-bottom: 1px solid #e5e7eb; }
        tr:hover { background: #f9fafb; }
        tr.highlighted { background: #fee2e2 !important; }
        tr.flash { animation: flash 1s ease-in-out; }
        @keyframes flash { 0%, 100% { background: inherit; } 50% { background: #fef3c7; } }
        .editable { cursor: text; min-width: 80px; display: inline-block; padding: 4px; border-radius: 3px; }
        .editable:hover { background: #f3f4f6; }
        .editable:focus { outline: 2px solid #667eea; background: white; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 8px; max-width: 400px; width: 90%; }
        .modal-content h3 { margin-bottom: 20px; }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .status-message { padding: 10px 20px; border-radius: 4px; margin: 10px 20px; display: none; }
        .status-message.success { background: #d1fae5; color: #065f46; display: block; }
        .status-message.error { background: #fee2e2; color: #991b1b; display: block; }
        select.laporan-select { width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 3px; font-size: 13px; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-warning:hover { background: #d97706; }
        .laporan-modal-content { background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 95%; max-height: 85vh; display: flex; flex-direction: column; }
        .laporan-modal-content h3 { margin-bottom: 15px; color: #374151; }
        .laporan-search { width: 100%; padding: 10px 14px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; margin-bottom: 10px; outline: none; transition: border-color 0.2s; }
        .laporan-search:focus { border-color: #667eea; }
        .class-filter-row { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
        .class-filter-btn { padding: 6px 14px; border: 1px solid #d1d5db; border-radius: 20px; background: white; cursor: pointer; font-size: 13px; transition: all 0.2s; }
        .class-filter-btn.active { background: #667eea; color: white; border-color: #667eea; }
        .student-list-container { flex: 1; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 15px; max-height: 350px; }
        .student-item { display: flex; align-items: center; padding: 10px 14px; border-bottom: 1px solid #f3f4f6; cursor: pointer; transition: background 0.15s; }
        .student-item:last-child { border-bottom: none; }
        .student-item:hover { background: #f0f4ff; }
        .student-item.checked { background: #eef2ff; }
        .student-item input[type="checkbox"] { margin-right: 12px; width: 18px; height: 18px; accent-color: #667eea; cursor: pointer; }
        .student-item-name { font-size: 14px; color: #1f2937; flex: 1; }
        .student-item-class { font-size: 12px; color: #6b7280; background: #f3f4f6; padding: 2px 8px; border-radius: 10px; }
        .laporan-footer { display: flex; justify-content: space-between; align-items: center; }
        .selected-count { font-size: 13px; color: #6b7280; }
        .selected-count strong { color: #667eea; }
        .laporan-footer-buttons { display: flex; gap: 10px; }
        .notification-toast { position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 16px 24px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 2000; display: none; animation: slideIn 0.3s ease-out; max-width: 400px; }
        .notification-toast.show { display: flex; align-items: center; gap: 10px; }
        .notification-toast .notif-icon { font-size: 20px; }
        .notification-toast .notif-text { font-size: 14px; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .select-all-row { display: flex; align-items: center; padding: 8px 14px; border-bottom: 2px solid #e5e7eb; background: #f9fafb; font-weight: 600; font-size: 13px; color: #374151; cursor: pointer; }
        .select-all-row input[type="checkbox"] { margin-right: 12px; width: 18px; height: 18px; accent-color: #667eea; cursor: pointer; }
        .no-results { padding: 30px; text-align: center; color: #9ca3af; font-size: 14px; }
        @media (max-width: 768px) {
            .header { padding: 15px; padding-right: 90px; }
            .header h1 { font-size: 16px; margin-bottom: 3px; }
            .header p { font-size: 12px; }
            .bell-icon { top: 15px; right: 50px; font-size: 22px; }
            .admin-icon { top: 15px; right: 15px; font-size: 22px; }
            .badge { top: 8px; right: 42px; font-size: 10px; padding: 1px 5px; min-width: 16px; }
            .controls-row { flex-direction: column; }
            input[type="text"], select, button { width: 100%; }
            table { font-size: 12px; }
            th, td { padding: 8px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Sistem Semak & Edit ID Delima Murid</h1>
            <p>SK Sri Aman</p>
            <div class="bell-icon" id="bellIcon">üîî</div>
            <div class="badge" id="laporanBadge">0</div>
            <div class="admin-icon" id="adminIcon">‚öôÔ∏è</div>
        </div>

        <div id="statusMessage" class="status-message"></div>

        <div class="controls">
            <div class="controls-row">
                <input type="text" id="searchInput" placeholder="üîç Cari murid (IC, Nama, Email, dll...)">
                <select id="filterTingkatan">
                    <option value="">Semua Darjah</option>
                    <option value="D1">D1</option>
                    <option value="D2">D2</option>
                    <option value="D3">D3</option>
                    <option value="D4">D4</option>
                    <option value="D5">D5</option>
                    <option value="D6">D6</option>
                </select>
                <select id="filterKelas">
                    <option value="">Semua Kelas</option>
                    <option value="BESTARI">BESTARI</option>
                    <option value="CEMERLANG">CEMERLANG</option>
                    <option value="GEMILANG">GEMILANG</option>
                </select>
            </div>
            <div class="controls-row">
                <button class="btn-warning" id="btnLaporanTiadaNama">üìã Laporan Murid Tiada Nama</button>
                <button class="btn-primary admin-only" id="btnAutoPromote">üöÄ Auto Naik Kelas (2026 ‚Üí 2027)</button>
                <button class="btn-success admin-only" id="btnSave">‚òÅÔ∏è Simpan ke Google Sheet</button>
                <button class="btn-secondary" id="btnPrint">üñ®Ô∏è Print Selected</button>
                <button class="btn-primary admin-only" id="btnNextLaporan">‚è≠Ô∏è Next Laporan</button>
                <button class="btn-success admin-only" id="btnMarkResolved">‚úÖ Mark as Resolved</button>
            </div>
        </div>

        <div class="table-container">
            <table id="studentTable">
                <thead>
                    <tr>
                        <th>No</th>
                        <th>IC MURID</th>
                        <th>Nama Murid</th>
                        <th>Darjah</th>
                        <th>Nama Kelas</th>
                        <th>Email</th>
                        <th>Password</th>
                        <th>LAPORAN</th>
                        <th class="admin-only">Tindakan</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="moveModal" class="modal">
        <div class="modal-content">
            <h3>Pindah Kelas</h3>
            <select id="moveClassSelect">
                <option value="D1-BESTARI">D1 BESTARI</option>
                <option value="D1-CEMERLANG">D1 CEMERLANG</option>
                <option value="D1-GEMILANG">D1 GEMILANG</option>
                <option value="D2-BESTARI">D2 BESTARI</option>
                <option value="D2-CEMERLANG">D2 CEMERLANG</option>
                <option value="D2-GEMILANG">D2 GEMILANG</option>
                <option value="D3-BESTARI">D3 BESTARI</option>
                <option value="D3-CEMERLANG">D3 CEMERLANG</option>
                <option value="D3-GEMILANG">D3 GEMILANG</option>
                <option value="D4-BESTARI">D4 BESTARI</option>
                <option value="D4-CEMERLANG">D4 CEMERLANG</option>
                <option value="D4-GEMILANG">D4 GEMILANG</option>
                <option value="D5-BESTARI">D5 BESTARI</option>
                <option value="D5-CEMERLANG">D5 CEMERLANG</option>
                <option value="D5-GEMILANG">D5 GEMILANG</option>
                <option value="D6-BESTARI">D6 BESTARI</option>
                <option value="D6-CEMERLANG">D6 CEMERLANG</option>
                <option value="D6-GEMILANG">D6 GEMILANG</option>
            </select>
            <div class="modal-buttons">
                <button class="btn-primary" id="btnConfirmMove">Pindah</button>
                <button class="btn-secondary" id="btnCancelMove">Batal</button>
            </div>
        </div>
    </div>

    <div id="laporanModal" class="modal">
        <div class="laporan-modal-content">
            <h3>üìã Laporan Murid Tiada Nama</h3>
            <input type="text" class="laporan-search" id="laporanSearch" placeholder="üîç Cari nama murid...">
            <div class="class-filter-row" id="classFilterRow">
                <button class="class-filter-btn active" data-class="all">Semua</button>
            </div>
            <div class="student-list-container" id="studentListContainer">
                <div class="select-all-row" id="selectAllRow">
                    <input type="checkbox" id="selectAllCheckbox">
                    <span>Pilih Semua</span>
                </div>
                <div id="studentCheckList"></div>
            </div>
            <div class="laporan-footer">
                <div class="selected-count">Dipilih: <strong id="selectedCountNum">0</strong> murid</div>
                <div class="laporan-footer-buttons">
                    <button class="btn-secondary" id="btnCancelLaporan">Batal</button>
                    <button class="btn-success" id="btnSubmitLaporan">üì§ Hantar Laporan</button>
                </div>
            </div>
        </div>
    </div>

    <div id="notificationToast" class="notification-toast">
        <span class="notif-icon">üîî</span>
        <span class="notif-text" id="notifText"></span>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbxKHTCYGWTlhzyPeAQqEersNLmcTzcSeDNkvrYE86MTtsvs4ORQyQ-EJwy1Z5N1OSjsEA/exec';
        let students = [];
        let headers = [];
        let isAdmin = false;
        let moveTargetIndex = -1;
        let currentLaporanIndex = -1;
        let laporanIndices = [];

        async function loadData() {
            try {
                showMessage('Memuatkan data...', 'success');
                
                const response = await fetch(API_URL, {
                    method: 'GET',
                    redirect: 'follow'
                });
                
                if (!response.ok) {
                    throw new Error('HTTP error! status: ' + response.status);
                }
                
                const data = await response.json();
                
                console.log('Raw data received:', data);
                console.log('Headers (Row 1):', data[0]);
                console.log('First student data:', data[1]);
                
                if (data && data.length > 0) {
                    headers = data[0];
                    
                    if (!headers.includes('LAPORAN')) {
                        headers.push('LAPORAN');
                    }
                    
                    students = data.slice(1).map(row => {
                        let obj = {};
                        headers.forEach((h, i) => {
                            obj[h] = row[i] || '';
                        });
                        if (!obj['LAPORAN']) {
                            obj['LAPORAN'] = '';
                        }
                        return obj;
                    });
                    
                    console.log('Total students:', students.length);
                    
                    renderTable();
                    updateBadge();
                    showMessage('Data berjaya dimuatkan (' + students.length + ' murid)', 'success');
                } else {
                    showMessage('Tiada data ditemui dalam sheet', 'error');
                }
            } catch (error) {
                console.error('Load error:', error);
                showMessage('Gagal memuatkan data: ' + error.message, 'error');
            }
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filterT = document.getElementById('filterTingkatan').value;
            const filterK = document.getElementById('filterKelas').value;

            laporanIndices = [];
            
            students.forEach(function(student, index) {
                const matchSearch = !searchTerm || Object.values(student).some(function(val) {
                    return String(val).toLowerCase().includes(searchTerm);
                });
                const matchTingkatan = !filterT || student['Darjah'] === filterT;
                const matchKelas = !filterK || student['Nama Kelas'] === filterK;
                
                if (matchSearch && matchTingkatan && matchKelas) {
                    const row = document.createElement('tr');
                    row.dataset.index = index;
                    
                    if (student['LAPORAN'] && student['LAPORAN'].trim() !== '') {
                        row.classList.add('highlighted');
                        laporanIndices.push(index);
                    }
                    
                    createCell(row, student['No'] || '', false, '', index);
                    createCell(row, student['IC MURID'] || '', isAdmin, 'IC MURID', index);
                    createCell(row, student['Nama Murid'] || '', isAdmin, 'Nama Murid', index);
                    createCell(row, student['Darjah'] || '', false, '', index);
                    createCell(row, student['Nama Kelas'] || '', false, '', index);
                    createCell(row, student['Email'] || '', isAdmin, 'Email', index);
                    createCell(row, student['Password'] || '', isAdmin, 'Password', index);
                    
                    const laporanCell = document.createElement('td');
                    const laporanSelect = document.createElement('select');
                    laporanSelect.className = 'laporan-select';
                    laporanSelect.dataset.index = index;
                    laporanSelect.onchange = function() { 
                        updateLaporan(index, this.value); 
                    };
                    if (!isAdmin && student['LAPORAN']) {
                        laporanSelect.disabled = true;
                    }
                    
                    addOption(laporanSelect, '', '-', student['LAPORAN'] === '');
                    addOption(laporanSelect, 'PASSWORD SALAH', 'PASSWORD SALAH', student['LAPORAN'] === 'PASSWORD SALAH');
                    addOption(laporanSelect, 'IC SALAH', 'IC SALAH', student['LAPORAN'] === 'IC SALAH');
                    addOption(laporanSelect, 'LAIN-LAIN', 'LAIN-LAIN', student['LAPORAN'] === 'LAIN-LAIN');
                    
                    laporanCell.appendChild(laporanSelect);
                    row.appendChild(laporanCell);
                    
                    const actionCell = document.createElement('td');
                    actionCell.className = 'admin-only';
                    const btnPindah = document.createElement('button');
                    btnPindah.className = 'btn-primary';
                    btnPindah.textContent = 'Pindah';
                    btnPindah.style.marginRight = '5px';
                    btnPindah.style.padding = '6px 12px';
                    btnPindah.onclick = function() { 
                        openMoveModal(index); 
                    };
                    
                    const btnPadam = document.createElement('button');
                    btnPadam.className = 'btn-danger';
                    btnPadam.textContent = 'Padam';
                    btnPadam.style.padding = '6px 12px';
                    btnPadam.onclick = function() { 
                        deleteStudent(index); 
                    };
                    
                    actionCell.appendChild(btnPindah);
                    actionCell.appendChild(btnPadam);
                    row.appendChild(actionCell);
                    
                    tbody.appendChild(row);
                }
            });

            attachEditListeners();
        }

        function createCell(row, value, editable, field, index) {
            const cell = document.createElement('td');
            if (editable) {
                const span = document.createElement('span');
                span.className = 'editable';
                span.contentEditable = 'true';
                span.dataset.field = field;
                span.dataset.index = index;
                span.textContent = value;
                cell.appendChild(span);
            } else {
                cell.textContent = value;
            }
            row.appendChild(cell);
        }

        function addOption(select, value, text, selected) {
            const opt = document.createElement('option');
            opt.value = value;
            opt.textContent = text;
            if (selected) opt.selected = true;
            select.appendChild(opt);
        }

        function attachEditListeners() {
            document.querySelectorAll('.editable').forEach(function(el) {
                el.addEventListener('blur', function() {
                    const field = this.dataset.field;
                    const index = parseInt(this.dataset.index);
                    const value = this.textContent.trim();
                    students[index][field] = value;
                });
            });
        }

        function updateLaporan(index, value) {
            students[index]['LAPORAN'] = value;
            updateBadge();
            renderTable();
        }

        function updateBadge() {
            const count = students.filter(function(s) {
                return s['LAPORAN'] && s['LAPORAN'].trim() !== '';
            }).length;
            const badge = document.getElementById('laporanBadge');
            badge.textContent = count;
            if (count > 0) {
                badge.classList.add('show');
            } else {
                badge.classList.remove('show');
            }
        }

        function scrollToFirstLaporan() {
            const rows = Array.from(document.querySelectorAll('#tableBody tr'));
            const firstLaporan = rows.find(function(row) {
                return row.classList.contains('highlighted');
            });
            
            if (firstLaporan) {
                firstLaporan.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstLaporan.classList.add('flash');
                setTimeout(function() {
                    firstLaporan.classList.remove('flash');
                }, 1000);
                currentLaporanIndex = laporanIndices.indexOf(parseInt(firstLaporan.dataset.index));
            }
        }

        function nextLaporan() {
            if (laporanIndices.length === 0) {
                showMessage('Tiada laporan untuk dilihat', 'error');
                return;
            }

            currentLaporanIndex = (currentLaporanIndex + 1) % laporanIndices.length;
            const targetIndex = laporanIndices[currentLaporanIndex];
            const targetRow = document.querySelector('tr[data-index="' + targetIndex + '"]');
            
            if (targetRow) {
                targetRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                targetRow.classList.add('flash');
                setTimeout(function() {
                    targetRow.classList.remove('flash');
                }, 1000);
            }
        }

        function markAsResolved() {
            if (laporanIndices.length === 0) {
                showMessage('Tiada laporan untuk diselesaikan', 'error');
                return;
            }

            if (currentLaporanIndex === -1 || currentLaporanIndex >= laporanIndices.length) {
                currentLaporanIndex = 0;
            }

            const targetIndex = laporanIndices[currentLaporanIndex];
            students[targetIndex]['LAPORAN'] = '';
            
            showMessage('Laporan telah diselesaikan', 'success');
            
            renderTable();
            updateBadge();
            
            if (laporanIndices.length > 0) {
                currentLaporanIndex = currentLaporanIndex % laporanIndices.length;
                nextLaporan();
            } else {
                currentLaporanIndex = -1;
                showMessage('Semua laporan telah selesai', 'success');
            }
        }

        function toggleAdmin() {
            if (!isAdmin) {
                const password = prompt('Masukkan password admin:');
                if (password === 'admin123') {
                    isAdmin = true;
                    document.body.classList.add('admin-mode');
                    renderTable();
                    showMessage('Mod Admin Diaktifkan', 'success');
                } else if (password !== null) {
                    showMessage('Password salah', 'error');
                }
            } else {
                isAdmin = false;
                document.body.classList.remove('admin-mode');
                renderTable();
                showMessage('Mod Admin Dimatikan', 'success');
            }
        }

        function openMoveModal(index) {
            moveTargetIndex = index;
            document.getElementById('moveModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('moveModal').classList.remove('show');
            moveTargetIndex = -1;
        }

        function confirmMove() {
            if (moveTargetIndex === -1) return;
            
            const selected = document.getElementById('moveClassSelect').value;
            const parts = selected.split('-');
            const darjah = parts[0];
            const kelas = parts[1];
            
            students[moveTargetIndex]['Darjah'] = darjah;
            students[moveTargetIndex]['Nama Kelas'] = kelas;
            
            closeModal();
            renderTable();
            showMessage('Murid berjaya dipindahkan', 'success');
        }

        function deleteStudent(index) {
            if (confirm('Adakah anda pasti mahu memadam murid ini?')) {
                students.splice(index, 1);
                renderTable();
                updateBadge();
                showMessage('Murid berjaya dipadam', 'success');
            }
        }

        function autoPromote() {
            if (!confirm('Auto naik kelas akan menaikkan semua murid dan memadam murid D6. Teruskan?')) {
                return;
            }

            const promoted = [];
            const removed = [];

            students.forEach(function(student) {
                const currentLevel = student['Darjah'];
                if (currentLevel === 'D1') {
                    student['Darjah'] = 'D2';
                    promoted.push(student);
                } else if (currentLevel === 'D2') {
                    student['Darjah'] = 'D3';
                    promoted.push(student);
                } else if (currentLevel === 'D3') {
                    student['Darjah'] = 'D4';
                    promoted.push(student);
                } else if (currentLevel === 'D4') {
                    student['Darjah'] = 'D5';
                    promoted.push(student);
                } else if (currentLevel === 'D5') {
                    student['Darjah'] = 'D6';
                    promoted.push(student);
                } else if (currentLevel === 'D6') {
                    removed.push(student);
                }
            });

            students = students.filter(function(s) {
                return s['Darjah'] !== 'D6' || removed.indexOf(s) === -1;
            });

            renderTable();
            updateBadge();
            showMessage('Auto naik kelas selesai. ' + promoted.length + ' murid dinaikkan, ' + removed.length + ' murid D6 dikeluarkan.', 'success');
        }

        async function saveToSheet() {
            try {
                const formData = new FormData();
                
                const dataRows = students.map(function(student) {
                    return headers.map(function(h) {
                        return student[h] || '';
                    });
                });
                
                formData.append('data', JSON.stringify(dataRows));

                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.status === 'success') {
                    showMessage('Data berjaya disimpan ke Google Sheet', 'success');
                } else {
                    showMessage('Gagal menyimpan: ' + (result.message || 'Unknown error'), 'error');
                }
            } catch (error) {
                showMessage('Ralat semasa menyimpan: ' + error.message, 'error');
            }
        }

        function printSelected() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filterT = document.getElementById('filterTingkatan').value;
            const filterK = document.getElementById('filterKelas').value;
            
            const filteredStudents = students.filter(function(student) {
                const matchSearch = !searchTerm || Object.values(student).some(function(val) {
                    return String(val).toLowerCase().includes(searchTerm);
                });
                const matchTingkatan = !filterT || student['Darjah'] === filterT;
                const matchKelas = !filterK || student['Nama Kelas'] === filterK;
                
                return matchSearch && matchTingkatan && matchKelas;
            });
            
            if (filteredStudents.length === 0) {
                showMessage('Tiada data untuk di print', 'error');
                return;
            }
            
            let printWindow = window.open('', '', 'width=800,height=600');
            
            let html = '<!DOCTYPE html><html><head><title>Print - ID Delima Murid</title>';
            html += '<style>';
            html += 'body { font-family: Arial, sans-serif; padding: 20px; }';
            html += 'h2 { text-align: center; margin-bottom: 5px; }';
            html += 'p { text-align: center; margin-bottom: 20px; color: #666; }';
            html += 'table { width: 100%; border-collapse: collapse; font-size: 12px; }';
            html += 'th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }';
            html += 'th { background-color: #667eea; color: white; font-weight: bold; }';
            html += 'tr:nth-child(even) { background-color: #f9f9f9; }';
            html += '@media print { button { display: none; } }';
            html += '</style></head><body>';
            
            html += '<h2>Sistem Semak & Edit ID Delima Murid</h2>';
            html += '<p>SK Sri Aman</p>';
            
            if (searchTerm || filterT || filterK) {
                html += '<p style="font-weight: bold;">Filter: ';
                if (searchTerm) html += 'Carian: "' + searchTerm + '" ';
                if (filterT) html += 'Darjah: ' + filterT + ' ';
                if (filterK) html += 'Kelas: ' + filterK + ' ';
                html += '</p>';
            }
            
            html += '<table>';
            html += '<thead><tr>';
            html += '<th>No</th>';
            html += '<th>IC MURID</th>';
            html += '<th>Nama Murid</th>';
            html += '<th>Darjah</th>';
            html += '<th>Nama Kelas</th>';
            html += '<th>Email</th>';
            html += '<th>Password</th>';
            html += '<th>LAPORAN</th>';
            html += '</tr></thead>';
            html += '<tbody>';
            
            filteredStudents.forEach(function(student) {
                html += '<tr>';
                html += '<td>' + (student['No'] || '') + '</td>';
                html += '<td>' + (student['IC MURID'] || '') + '</td>';
                html += '<td>' + (student['Nama Murid'] || '') + '</td>';
                html += '<td>' + (student['Darjah'] || '') + '</td>';
                html += '<td>' + (student['Nama Kelas'] || '') + '</td>';
                html += '<td>' + (student['Email'] || '') + '</td>';
                html += '<td>' + (student['Password'] || '') + '</td>';
                html += '<td>' + (student['LAPORAN'] || '') + '</td>';
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            html += '<p style="margin-top: 20px; font-size: 11px; color: #999;">Jumlah rekod: ' + filteredStudents.length + ' murid</p>';
            html += '</body></html>';
            
            printWindow.document.write(html);
            printWindow.document.close();
            
            printWindow.onload = function() {
                printWindow.focus();
                printWindow.print();
            };
        }

        function showMessage(message, type) {
            const msgEl = document.getElementById('statusMessage');
            msgEl.textContent = message;
            msgEl.className = 'status-message ' + type;
            
            setTimeout(function() {
                msgEl.className = 'status-message';
            }, 4000);
        }

        // Firebase Config - Kehadiran Murid (READ ONLY - fetch student names)
        const kehadiranFirebaseConfig = {
            apiKey: "AIzaSyDbCgDz2vK2BZUpwM3iDWJcPQSptVcNkv4",
            authDomain: "kehadiran-murid-6ece0.firebaseapp.com",
            databaseURL: "https://kehadiran-murid-6ece0-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "kehadiran-murid-6ece0",
            storageBucket: "kehadiran-murid-6ece0.firebasestorage.app",
            messagingSenderId: "223849234784",
            appId: "1:223849234784:web:e1471ded7ea17ba60bde05",
            measurementId: "G-4DY138HKTW"
        };

        // Firebase Config - Delima Database (WRITE reports here)
        const delimaFirebaseConfig = {
            apiKey: "AIzaSyC54PGqXbP5jyxA8C1Yh9uLeJaO5GHnfBo",
            authDomain: "delimadatabasesriaman.firebaseapp.com",
            databaseURL: "https://delimadatabasesriaman-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "delimadatabasesriaman",
            storageBucket: "delimadatabasesriaman.firebasestorage.app",
            messagingSenderId: "349885664668",
            appId: "1:349885664668:web:4317d1af6f239e2c780c59",
            measurementId: "G-Z3BT8MGP1G"
        };

        const kehadiranApp = firebase.initializeApp(kehadiranFirebaseConfig, 'kehadiran');
        const delimaApp = firebase.initializeApp(delimaFirebaseConfig, 'delima');
        const kehadiranDb = firebase.database(kehadiranApp);
        const delimaDb = firebase.database(delimaApp);

        let firebaseStudents = [];
        let selectedStudents = new Set();
        let activeClassFilter = 'all';

        async function fetchFirebaseStudents() {
            try {
                const snapshot = await kehadiranDb.ref('config/classes/classData').once('value');
                const classData = snapshot.val();
                firebaseStudents = [];

                if (classData) {
                    Object.keys(classData).forEach(function(className) {
                        const studentsInClass = classData[className];
                        if (studentsInClass) {
                            if (Array.isArray(studentsInClass)) {
                                studentsInClass.forEach(function(name) {
                                    if (name && name.trim()) {
                                        firebaseStudents.push({ name: name.trim(), className: className });
                                    }
                                });
                            } else {
                                Object.keys(studentsInClass).forEach(function(key) {
                                    var name = studentsInClass[key];
                                    if (name && typeof name === 'string' && name.trim()) {
                                        firebaseStudents.push({ name: name.trim(), className: className });
                                    }
                                });
                            }
                        }
                    });
                }

                firebaseStudents.sort(function(a, b) {
                    if (a.className < b.className) return -1;
                    if (a.className > b.className) return 1;
                    return a.name.localeCompare(b.name);
                });

                return firebaseStudents;
            } catch (error) {
                console.error('Error fetching Firebase students:', error);
                showMessage('Gagal memuatkan senarai murid dari Firebase: ' + error.message, 'error');
                return [];
            }
        }

        function getAvailableClasses() {
            var classes = [];
            firebaseStudents.forEach(function(s) {
                if (classes.indexOf(s.className) === -1) {
                    classes.push(s.className);
                }
            });
            classes.sort();
            return classes;
        }

        function renderClassFilters() {
            var filterRow = document.getElementById('classFilterRow');
            filterRow.innerHTML = '<button class="class-filter-btn ' + (activeClassFilter === 'all' ? 'active' : '') + '" data-class="all">Semua</button>';
            var classes = getAvailableClasses();
            classes.forEach(function(cls) {
                var btn = document.createElement('button');
                btn.className = 'class-filter-btn' + (activeClassFilter === cls ? ' active' : '');
                btn.dataset.class = cls;
                btn.textContent = cls;
                btn.addEventListener('click', function() {
                    activeClassFilter = cls;
                    updateClassFilterUI();
                    renderStudentCheckList();
                });
                filterRow.appendChild(btn);
            });

            filterRow.querySelector('[data-class="all"]').addEventListener('click', function() {
                activeClassFilter = 'all';
                updateClassFilterUI();
                renderStudentCheckList();
            });
        }

        function updateClassFilterUI() {
            document.querySelectorAll('.class-filter-btn').forEach(function(btn) {
                btn.classList.remove('active');
                if (btn.dataset.class === activeClassFilter) {
                    btn.classList.add('active');
                }
            });
        }

        function renderStudentCheckList() {
            var container = document.getElementById('studentCheckList');
            var searchTerm = document.getElementById('laporanSearch').value.toLowerCase().trim();
            container.innerHTML = '';

            var filtered = firebaseStudents.filter(function(s) {
                var matchClass = activeClassFilter === 'all' || s.className === activeClassFilter;
                var matchSearch = !searchTerm || s.name.toLowerCase().includes(searchTerm);
                return matchClass && matchSearch;
            });

            if (filtered.length === 0) {
                container.innerHTML = '<div class="no-results">Tiada murid dijumpai</div>';
                return;
            }

            filtered.forEach(function(student) {
                var key = student.className + '|' + student.name;
                var div = document.createElement('div');
                div.className = 'student-item' + (selectedStudents.has(key) ? ' checked' : '');

                var checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = selectedStudents.has(key);
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        selectedStudents.add(key);
                        div.classList.add('checked');
                    } else {
                        selectedStudents.delete(key);
                        div.classList.remove('checked');
                    }
                    updateSelectedCount();
                    updateSelectAllCheckbox();
                });

                var nameSpan = document.createElement('span');
                nameSpan.className = 'student-item-name';
                nameSpan.textContent = student.name;

                var classSpan = document.createElement('span');
                classSpan.className = 'student-item-class';
                classSpan.textContent = student.className;

                div.appendChild(checkbox);
                div.appendChild(nameSpan);
                div.appendChild(classSpan);

                div.addEventListener('click', function(e) {
                    if (e.target.tagName !== 'INPUT') {
                        checkbox.checked = !checkbox.checked;
                        checkbox.dispatchEvent(new Event('change'));
                    }
                });

                container.appendChild(div);
            });

            updateSelectAllCheckbox();
        }

        function updateSelectedCount() {
            document.getElementById('selectedCountNum').textContent = selectedStudents.size;
        }

        function updateSelectAllCheckbox() {
            var container = document.getElementById('studentCheckList');
            var checkboxes = container.querySelectorAll('input[type="checkbox"]');
            var allChecked = checkboxes.length > 0 && Array.from(checkboxes).every(function(cb) { return cb.checked; });
            document.getElementById('selectAllCheckbox').checked = allChecked;
        }

        function toggleSelectAll() {
            var container = document.getElementById('studentCheckList');
            var checkboxes = container.querySelectorAll('input[type="checkbox"]');
            var selectAllCb = document.getElementById('selectAllCheckbox');
            var shouldCheck = selectAllCb.checked;

            checkboxes.forEach(function(cb) {
                if (cb.checked !== shouldCheck) {
                    cb.checked = shouldCheck;
                    cb.dispatchEvent(new Event('change'));
                }
            });
        }

        async function openLaporanModal() {
            selectedStudents.clear();
            activeClassFilter = 'all';
            document.getElementById('laporanSearch').value = '';
            updateSelectedCount();

            document.getElementById('laporanModal').classList.add('show');
            showMessage('Memuatkan senarai murid...', 'success');

            await fetchFirebaseStudents();

            if (firebaseStudents.length > 0) {
                renderClassFilters();
                renderStudentCheckList();
                showMessage('Senarai murid berjaya dimuatkan (' + firebaseStudents.length + ' murid)', 'success');
            } else {
                showMessage('Tiada data murid ditemui', 'error');
            }
        }

        function closeLaporanModal() {
            document.getElementById('laporanModal').classList.remove('show');
        }

        async function submitLaporan() {
            if (selectedStudents.size === 0) {
                showMessage('Sila pilih sekurang-kurangnya seorang murid', 'error');
                return;
            }

            var selectedList = [];
            selectedStudents.forEach(function(key) {
                var parts = key.split('|');
                selectedList.push({ className: parts[0], name: parts[1] });
            });

            var report = {
                tajuk: 'LAPORAN MURID TIADA NAMA',
                tarikhLaporan: new Date().toISOString(),
                tarikhDisplay: new Date().toLocaleString('ms-MY', {
                    day: '2-digit', month: '2-digit', year: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                }),
                jumlahMurid: selectedList.length,
                senaraiMurid: selectedList,
                status: 'BARU'
            };

            try {
                var newRef = delimaDb.ref('laporanMuridTiadaNama').push();
                await newRef.set(report);

                // Add notification for admin
                var notifRef = delimaDb.ref('notifications').push();
                await notifRef.set({
                    type: 'LAPORAN_TIADA_NAMA',
                    message: 'Laporan baharu: ' + selectedList.length + ' murid tiada nama tag dilaporkan',
                    reportId: newRef.key,
                    timestamp: new Date().toISOString(),
                    read: false
                });

                closeLaporanModal();
                showMessage('Laporan berjaya dihantar! (' + selectedList.length + ' murid)', 'success');
                showNotification('Laporan baharu berjaya dihantar! ' + selectedList.length + ' murid tiada nama telah dilaporkan. Admin akan mengambil tindakan.');
            } catch (error) {
                console.error('Error saving report:', error);
                showMessage('Gagal menghantar laporan: ' + error.message, 'error');
            }
        }

        function showNotification(message) {
            var toast = document.getElementById('notificationToast');
            document.getElementById('notifText').textContent = message;
            toast.classList.add('show');
            setTimeout(function() {
                toast.classList.remove('show');
            }, 6000);
        }

        // Listen for new notifications from Firebase
        function listenForNotifications() {
            delimaDb.ref('notifications').orderByChild('read').equalTo(false).on('child_added', function(snapshot) {
                var notif = snapshot.val();
                if (notif && notif.type === 'LAPORAN_TIADA_NAMA') {
                    showNotification('‚ö†Ô∏è ' + notif.message);
                }
            });
        }

        window.addEventListener('DOMContentLoaded', function() {
            document.getElementById('searchInput').addEventListener('input', renderTable);
            document.getElementById('filterTingkatan').addEventListener('change', renderTable);
            document.getElementById('filterKelas').addEventListener('change', renderTable);
            document.getElementById('bellIcon').addEventListener('click', scrollToFirstLaporan);
            document.getElementById('adminIcon').addEventListener('click', toggleAdmin);
            
            const btnAutoPromote = document.getElementById('btnAutoPromote');
            if (btnAutoPromote) btnAutoPromote.addEventListener('click', autoPromote);
            
            const btnSave = document.getElementById('btnSave');
            if (btnSave) btnSave.addEventListener('click', saveToSheet);
            
            const btnPrint = document.getElementById('btnPrint');
            if (btnPrint) btnPrint.addEventListener('click', printSelected);
            
            const btnNextLaporan = document.getElementById('btnNextLaporan');
            if (btnNextLaporan) btnNextLaporan.addEventListener('click', nextLaporan);
            
            const btnMarkResolved = document.getElementById('btnMarkResolved');
            if (btnMarkResolved) btnMarkResolved.addEventListener('click', markAsResolved);
            
            const btnConfirmMove = document.getElementById('btnConfirmMove');
            if (btnConfirmMove) btnConfirmMove.addEventListener('click', confirmMove);
            
            const btnCancelMove = document.getElementById('btnCancelMove');
            if (btnCancelMove) btnCancelMove.addEventListener('click', closeModal);

            var btnLaporanTiadaNama = document.getElementById('btnLaporanTiadaNama');
            if (btnLaporanTiadaNama) btnLaporanTiadaNama.addEventListener('click', openLaporanModal);

            var btnCancelLaporan = document.getElementById('btnCancelLaporan');
            if (btnCancelLaporan) btnCancelLaporan.addEventListener('click', closeLaporanModal);

            var btnSubmitLaporan = document.getElementById('btnSubmitLaporan');
            if (btnSubmitLaporan) btnSubmitLaporan.addEventListener('click', submitLaporan);

            var selectAllCheckbox = document.getElementById('selectAllCheckbox');
            if (selectAllCheckbox) selectAllCheckbox.addEventListener('change', toggleSelectAll);

            var laporanSearch = document.getElementById('laporanSearch');
            if (laporanSearch) laporanSearch.addEventListener('input', renderStudentCheckList);

            listenForNotifications();
            loadData();
        });
    </script>
</body>
</html>
