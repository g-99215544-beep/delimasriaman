<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Semak & Edit ID Delima Murid - SK Sri Aman</title>
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #1e40af;
            --accent: #d97706;
            --danger: #dc2626;
            --success: #16a34a;
            --bg: #f3f4f6;
            --text: #1f2937;
            --border: #e5e7eb;
            --white: #ffffff;
        }

        * {
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg);
            color: var(--text);
            font-size: 14px;
        }

        /* --- Header --- */
        header {
            background-color: var(--primary);
            color: var(--white);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .brand {
            font-weight: bold;
            font-size: 1.1rem;
            display: flex;
            flex-direction: column;
        }

        .brand span {
            font-size: 0.8rem;
            opacity: 0.9;
            font-weight: normal;
        }

        .admin-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .admin-btn:hover {
            background-color: rgba(255,255,255,0.2);
        }

        /* --- Controls --- */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        .controls {
            background: var(--white);
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
            position: relative;
        }

        input, select, button {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 14px;
            outline: none;
        }

        input:focus, select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
        }

        .search-box input {
            width: 100%;
        }

        /* --- Action Buttons --- */
        .btn {
            cursor: pointer;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: opacity 0.2s;
            border: none;
            color: white;
        }

        .btn:hover { opacity: 0.9; }
        
        .btn-save { background-color: var(--success); }
        .btn-export { background-color: var(--secondary); }
        .btn-promo { background-color: var(--accent); }
        .btn-move { background-color: var(--primary); font-size: 12px; padding: 4px 8px; }
        .btn-del { background-color: var(--danger); font-size: 12px; padding: 4px 8px; }

        .admin-only {
            display: none !important;
        }

        body.is-admin .admin-only {
            display: inline-flex !important;
        }

        body.is-admin .admin-col {
            display: table-cell !important;
        }

        /* --- Table --- */
        .table-container {
            background: var(--white);
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow-x: auto;
            min-height: 400px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            white-space: nowrap;
        }

        th, td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background-color: #f8fafc;
            font-weight: 600;
            color: var(--text);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:hover {
            background-color: #f1f5f9;
        }

        .editable-cell {
            transition: background 0.2s;
        }

        body.is-admin .editable-cell:hover {
            background-color: #fffbeb;
            cursor: text;
            outline: 1px dashed var(--accent);
        }
        
        body.is-admin .editable-cell:focus {
            background-color: #fff;
            outline: 2px solid var(--primary);
        }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal {
            background: var(--white);
            padding: 1.5rem;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .modal h3 { margin-top: 0; }

        .modal-actions {
            margin-top: 1.5rem;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn-cancel {
            background-color: #9ca3af;
            color: white;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group select, .form-group input {
            width: 100%;
        }

        /* --- Notification --- */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        .toast.show { opacity: 1; }

        .loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            font-weight: bold;
            color: var(--primary);
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .controls { flex-direction: column; align-items: stretch; }
            .btn { width: 100%; justify-content: center; margin-bottom: 5px; }
        }
    </style>
</head>
<body>

    <!-- Loading Screen -->
    <div id="loading" class="loading-overlay">
        <div class="spinner"></div>
        <div id="loadingText">Sedang memuat data...</div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">Mesej sistem</div>

    <header>
        <div class="brand">
            Sistem Semak & Edit ID Delima
            <span>SK Sri Aman</span>
        </div>
        <button class="admin-btn" onclick="openAdminLogin()" title="Admin Login">‚öôÔ∏è</button>
    </header>

    <div class="container">
        
        <!-- Controls Bar -->
        <div class="controls">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Cari Nama, IC, ID, dll..." onkeyup="handleSearch()">
            </div>
            
            <select id="filterTingkatan" onchange="applyFilters()">
                <option value="">Semua Tingkatan</option>
                <option value="D1">D1</option>
                <option value="D2">D2</option>
                <option value="D3">D3</option>
                <option value="D4">D4</option>
                <option value="D5">D5</option>
                <option value="D6">D6</option>
            </select>

            <select id="filterKelas" onchange="applyFilters()">
                <option value="">Semua Kelas</option>
                <option value="BESTARI">BESTARI</option>
                <option value="CEMERLANG">CEMERLANG</option>
                <option value="GEMILANG">GEMILANG</option>
            </select>
        </div>

        <!-- Admin Action Bar -->
        <div class="controls admin-only" style="background: #eef2ff; border: 1px solid #c7d2fe;">
            <div style="font-weight: bold; color: var(--secondary); margin-right: auto;">MOD ADMIN</div>
            <button class="btn btn-promo" onclick="autoPromote()">üöÄ Auto Naik Kelas</button>
            <button class="btn btn-export" onclick="downloadExcel()">‚¨á Download Excel</button>
            <button class="btn btn-save" onclick="saveData()">‚òÅÔ∏è Simpan ke Google Sheet</button>
        </div>

        <!-- Data Table -->
        <div class="table-container">
            <table id="dataTable">
                <thead>
                    <tr id="tableHeader">
                        <!-- Headers generated via JS -->
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Rows generated via JS -->
                </tbody>
            </table>
        </div>
        <div id="noData" style="text-align: center; padding: 2rem; color: #666; display: none;">Tiada rekod dijumpai.</div>

    </div>

    <!-- Admin Login Modal -->
    <div id="modalLogin" class="modal-overlay">
        <div class="modal">
            <h3>Login Pentadbir</h3>
            <div class="form-group">
                <label>Kata Laluan</label>
                <input type="password" id="adminPassword" placeholder="Masukkan password">
            </div>
            <div class="modal-actions">
                <button class="btn btn-cancel" onclick="closeModal('modalLogin')">Batal</button>
                <button class="btn btn-move" onclick="checkLogin()">Masuk</button>
            </div>
        </div>
    </div>

    <!-- Move Class Modal -->
    <div id="modalMove" class="modal-overlay">
        <div class="modal">
            <h3>Pindah Kelas</h3>
            <p id="moveStudentName" style="color: #666; margin-bottom: 1rem;"></p>
            <input type="hidden" id="moveStudentId">
            
            <div class="form-group">
                <label>Tingkatan Baru</label>
                <select id="newTingkatan">
                    <option value="D1">D1</option>
                    <option value="D2">D2</option>
                    <option value="D3">D3</option>
                    <option value="D4">D4</option>
                    <option value="D5">D5</option>
                    <option value="D6">D6</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Kelas Baru</label>
                <select id="newKelas">
                    <option value="BESTARI">BESTARI</option>
                    <option value="CEMERLANG">CEMERLANG</option>
                    <option value="GEMILANG">GEMILANG</option>
                </select>
            </div>

            <div class="modal-actions">
                <button class="btn btn-cancel" onclick="closeModal('modalMove')">Batal</button>
                <button class="btn btn-move" onclick="confirmMove()">Simpan Pindah</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        // Sila pastikan URL ini dikemaskini dengan URL "Web App" yang baru jika anda melakukan Deploy semula
        const API_URL = "https://script.google.com/macros/s/AKfycbxZVnrpcL_2dCx7PPQCA07Q6j3GLN_0xyCqgLazLsJ0yaOD6uLeScf1w1GkAyFKzPG7VQ/exec";
        
        // --- STATE ---
        let rawData = []; // Full 2D array from sheet
        let headers = []; // Extracted headers
        let tableData = []; // Array of objects for app manipulation
        let isAdmin = false;

        // Column Mapping (Indices)
        let colMap = {
            nama: -1,
            ic: -1,
            email: -1, // ID Delima
            password: -1,
            tingkatan: -1,
            kelas: -1
        };

        // --- INITIALIZATION ---
        window.onload = function() {
            fetchData();
        };

        async function fetchData() {
            showLoading(true, "Sedang mengambil data...");
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error("Network response was not ok");
                
                rawData = await response.json();
                
                if (!rawData || rawData.length === 0) {
                    showToast("Tiada data diterima");
                    return;
                }

                processData(rawData);
                renderTable();
            } catch (error) {
                console.error("Error fetching data:", error);
                showToast("Gagal mengambil data. Sila refresh.");
            } finally {
                showLoading(false);
            }
        }

        function processData(data) {
            // Extract headers (Row 0)
            headers = data[0].map(h => (h || "").toString().trim());
            
            // Map columns based on common names
            headers.forEach((h, index) => {
                const lower = h.toLowerCase();
                if (lower.includes("nama") && lower.includes("murid")) colMap.nama = index;
                else if (lower.includes("ic") || lower.includes("kp") || lower.includes("mykid")) colMap.ic = index;
                else if (lower.includes("id") || lower.includes("email") || lower.includes("delima")) colMap.email = index;
                else if (lower.includes("password") || lower.includes("laluan")) colMap.password = index;
                else if (lower.includes("tingkatan") || lower.includes("darjah")) colMap.tingkatan = index;
                else if (lower.includes("kelas")) colMap.kelas = index;
            });

            // Convert remaining rows to objects containing both value and original index
            tableData = [];
            for (let i = 1; i < data.length; i++) {
                let row = data[i];
                // Ensure row has enough columns
                while (row.length < headers.length) row.push("");
                
                let rowObj = {
                    _originalIndex: i, // To track position for saving
                    data: [...row]     // Copy of array data
                };
                tableData.push(rowObj);
            }
        }

        // --- RENDERING ---
        function renderTable() {
            const tbody = document.getElementById("tableBody");
            const thead = document.getElementById("tableHeader");
            const filterTing = document.getElementById("filterTingkatan").value;
            const filterKls = document.getElementById("filterKelas").value;
            const searchTxt = document.getElementById("searchInput").value.toLowerCase();

            tbody.innerHTML = "";
            
            // Render Headers only once
            if (thead.children.length === 0) {
                headers.forEach(h => {
                    const th = document.createElement("th");
                    th.textContent = h;
                    thead.appendChild(th);
                });
                // Action column
                const thAct = document.createElement("th");
                thAct.textContent = "Aksi";
                thAct.className = "admin-only admin-col";
                thAct.style.display = isAdmin ? "table-cell" : "none";
                thead.appendChild(thAct);
            } else {
                // Toggle admin column visibility
                const lastTh = thead.lastElementChild;
                lastTh.style.display = isAdmin ? "table-cell" : "none";
            }

            // Filter Logic
            let visibleCount = 0;
            tableData.forEach((rowObj, index) => {
                const row = rowObj.data;
                const tingkatan = colMap.tingkatan > -1 ? row[colMap.tingkatan] : "";
                const kelas = colMap.kelas > -1 ? row[colMap.kelas] : "";
                
                // 1. Dropdown Filters
                if (filterTing && tingkatan !== filterTing) return;
                if (filterKls && kelas !== filterKls) return;

                // 2. Search
                const rowStr = row.join(" ").toLowerCase();
                if (searchTxt && !rowStr.includes(searchTxt)) return;

                // 3. Render Row
                visibleCount++;
                const tr = document.createElement("tr");
                tr.dataset.idx = index; // Store index in tableData array

                row.forEach((cellVal, colIdx) => {
                    const td = document.createElement("td");
                    td.textContent = cellVal;
                    
                    if (isAdmin) {
                        td.contentEditable = "true";
                        td.classList.add("editable-cell");
                        // Add listener to save edits to local state
                        td.onblur = function() {
                            updateCell(index, colIdx, this.textContent);
                        };
                    }
                    tr.appendChild(td);
                });

                // Admin Actions Column
                const tdAction = document.createElement("td");
                tdAction.className = "admin-only admin-col";
                tdAction.style.display = isAdmin ? "table-cell" : "none";
                tdAction.style.whiteSpace = "nowrap";
                
                const btnMove = document.createElement("button");
                btnMove.className = "btn btn-move";
                btnMove.textContent = "Pindah";
                btnMove.onclick = () => openMoveModal(index);
                
                const btnDel = document.createElement("button");
                btnDel.className = "btn btn-del";
                btnDel.textContent = "Hapus";
                btnDel.style.marginLeft = "5px";
                btnDel.onclick = () => deleteStudent(index);

                tdAction.appendChild(btnMove);
                tdAction.appendChild(btnDel);
                tr.appendChild(tdAction);

                tbody.appendChild(tr);
            });

            document.getElementById("noData").style.display = visibleCount === 0 ? "block" : "none";
        }

        // --- CORE FEATURES ---

        function handleSearch() { renderTable(); }
        function applyFilters() { renderTable(); }

        // Update local state when cell is edited
        function updateCell(rowIndex, colIndex, newValue) {
            tableData[rowIndex].data[colIndex] = newValue.trim();
        }

        // --- ADMIN SYSTEM ---

        function openAdminLogin() {
            if (isAdmin) {
                // Logout logic if already admin
                if(confirm("Log keluar admin?")) {
                    isAdmin = false;
                    document.body.classList.remove("is-admin");
                    renderTable();
                    showToast("Admin log keluar berjaya");
                }
            } else {
                document.getElementById("modalLogin").style.display = "flex";
                document.getElementById("adminPassword").value = "";
                document.getElementById("adminPassword").focus();
            }
        }

        function checkLogin() {
            const pass = document.getElementById("adminPassword").value;
            if (pass === "admin123") {
                isAdmin = true;
                document.body.classList.add("is-admin");
                closeModal("modalLogin");
                renderTable();
                showToast("Mod Admin Diaktifkan");
            } else {
                alert("Password salah!");
            }
        }

        // --- MOVE CLASS LOGIC ---

        let currentMoveIndex = -1;

        function openMoveModal(index) {
            currentMoveIndex = index;
            const name = tableData[index].data[colMap.nama];
            const ting = tableData[index].data[colMap.tingkatan];
            const kls = tableData[index].data[colMap.kelas];

            document.getElementById("moveStudentName").textContent = "Murid: " + name;
            
            // Set current values
            const tSelect = document.getElementById("newTingkatan");
            const kSelect = document.getElementById("newKelas");
            
            // Try to match current values, else default
            if(Array.from(tSelect.options).some(o => o.value === ting)) tSelect.value = ting;
            else tSelect.selectedIndex = 0;

            if(Array.from(kSelect.options).some(o => o.value === kls)) kSelect.value = kls;
            else kSelect.selectedIndex = 0;

            document.getElementById("modalMove").style.display = "flex";
        }

        function confirmMove() {
            if (currentMoveIndex === -1) return;
            
            const newTing = document.getElementById("newTingkatan").value;
            const newKls = document.getElementById("newKelas").value;

            // Update State
            if (colMap.tingkatan > -1) tableData[currentMoveIndex].data[colMap.tingkatan] = newTing;
            if (colMap.kelas > -1) tableData[currentMoveIndex].data[colMap.kelas] = newKls;

            closeModal("modalMove");
            renderTable();
            showToast("Murid berjaya dipindah.");
        }

        // --- DELETE LOGIC ---

        function deleteStudent(index) {
            const name = tableData[index].data[colMap.nama];
            if (confirm(`Adakah anda pasti mahu memadam murid ini?\n\n${name}`)) {
                tableData.splice(index, 1);
                renderTable();
                showToast("Murid dipadam.");
            }
        }

        // --- AUTO PROMOTION LOGIC ---

        function autoPromote() {
            if (!confirm("AMARAN: Ini akan menaikkan semua murid 1 tahun (Cth: D1->D2) dan MEMADAM semua murid D6.\n\nAdakah anda pasti?")) return;

            if (colMap.tingkatan === -1) {
                alert("Ralat: Kolum 'Tingkatan' tidak dijumpai.");
                return;
            }

            let promotedCount = 0;
            let removedCount = 0;
            const newTableData = [];

            tableData.forEach(rowObj => {
                let currentTing = rowObj.data[colMap.tingkatan].toUpperCase().trim();
                
                // Logic: Extract number from D1, D2 etc
                let match = currentTing.match(/D(\d)/);
                if (match) {
                    let level = parseInt(match[1]);
                    if (level < 6) {
                        // Promote
                        let newLevel = level + 1;
                        rowObj.data[colMap.tingkatan] = "D" + newLevel;
                        newTableData.push(rowObj);
                        promotedCount++;
                    } else if (level === 6) {
                        // Remove D6
                        removedCount++;
                        // Do not push to newTableData
                    } else {
                        // Keep weird data intact
                        newTableData.push(rowObj);
                    }
                } else {
                    // Keep rows that don't match D1-D6 format
                    newTableData.push(rowObj);
                }
            });

            tableData = newTableData;
            renderTable();
            alert(`Proses Selesai.\n\nMurid Dinaikkan: ${promotedCount}\nMurid D6 Dipadam: ${removedCount}\n\nSila tekan 'Simpan ke Google Sheet' untuk kekalkan perubahan.`);
        }

        // --- EXPORT & SAVE ---

        function downloadExcel() {
            // Generate CSV content
            let csvContent = "\uFEFF"; // BOM for UTF-8 in Excel
            
            // Headers
            csvContent += headers.join(",") + "\n";

            // Rows
            tableData.forEach(rowObj => {
                let row = rowObj.data.map(e => {
                    // Escape quotes and wrap in quotes if contains comma
                    let cell = String(e || "").replace(/"/g, '""');
                    if (cell.search(/("|,|\n)/g) >= 0) cell = `"${cell}"`;
                    return cell;
                });
                csvContent += row.join(",") + "\n";
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", "Data_ID_Delima_" + new Date().toISOString().slice(0,10) + ".csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function saveData() {
            if (!confirm("Simpan perubahan ke Google Sheet? Data sedia ada akan digantikan sepenuhnya.")) return;

            showLoading(true, "Sedang menyimpan... (Ini mungkin mengambil masa)");

            // Reconstruct full 2D array [Headers, ...Rows]
            const finalData = [headers];
            tableData.forEach(rowObj => finalData.push(rowObj.data));

            const formData = new FormData();
            formData.append('data', JSON.stringify(finalData));

            try {
                // Gunakan mode: 'no-cors' untuk elak error cross-origin, 
                // TETAPI pastikan App Script anda telah dikemaskini dengan kod baru.
                await fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: formData
                });
                
                showLoading(false);
                alert("‚úÖ Permintaan simpan dihantar!\n\nSila tunggu 5-10 saat sebelum refresh page untuk lihat perubahan.");
                
                // Refresh data after delay
                setTimeout(() => fetchData(), 5000); 

            } catch (error) {
                console.error("Save error:", error);
                showLoading(false);
                alert("Ralat sambungan: " + error.message);
            }
        }

        // --- UTILS ---
        function closeModal(id) {
            document.getElementById(id).style.display = "none";
        }
        
        function showLoading(show, text) {
            const el = document.getElementById("loading");
            const txt = document.getElementById("loadingText");
            el.style.display = show ? "flex" : "none";
            if(text) txt.textContent = text;
        }

        function showToast(msg) {
            const t = document.getElementById("toast");
            t.textContent = msg;
            t.classList.add("show");
            setTimeout(() => t.classList.remove("show"), 3000);
        }

        // Close modal on outside click
        window.onclick = function(event) {
            if (event.target.classList.contains('modal-overlay')) {
                event.target.style.display = "none";
            }
        }
    </script>
</body>
</html>
